#include "serializer.hpp"

#include <fstream>

#include "serializer.class.hpp"
#include "serializer.enum.hpp"
#include "serializer.function.hpp"

using namespace std;
using namespace reflang;

namespace
{
	void Begin(ostream& o, const serializer::Options& options)
	{
		o << R"(// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// !!! This file is auto-generated by Reflang. !!!
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

#include <cassert>
#include <stdexcept>
#include <string>

)";
		o << options.include_path;
		o << R"(

namespace reflang
{

)";
	}

	void End(ostream& o)
	{
		o << "}  // namespace reflang\n";
	}
}  // namespace

void serializer::Serialize(
		const std::vector<std::unique_ptr<TypeBase>>& types,
		const Options& options)
{
	std::unique_ptr<ofstream> fout;
	ostream* o = &cout;

	if (!options.out_hpp_path.empty())
	{
		fout = make_unique<ofstream>(options.out_hpp_path.c_str());
		o = fout.get();
	}

	Begin(*o, options);
	for (const auto& type : types)
	{
		switch (type->GetType())
		{
			case TypeBase::Type::Enum:
				SerializeEnum(*o, static_cast<const Enum&>(*type));
				break;
			case TypeBase::Type::Function:
				SerializeFunction(*o, static_cast<const Function&>(*type));
				break;
			case TypeBase::Type::Class:
				SerializeClass(*o, static_cast<const Class&>(*type));
				break;
		}
		*o << "\n\n";
	}
	End(*o);
}
